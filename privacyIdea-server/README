# PrivacyIDEA PAM for SSH (CentOS 7 & Ubuntu 22.04)

This guide explains how to install and configure the **PrivacyIDEA PAM module** for SSH authentication with **OTP (One-Time Password)**.

You can use this to enforce **SSH login with Public Key + OTP** via PrivacyIDEA.


## üìå Prerequisites

- A working **PrivacyIDEA server**  
- SSH access to your Linux server  
- A registered OTP token for your user in PrivacyIDEA

---
##############################################
## ‚öôÔ∏è CentOS 7 Installation (Manual Build) ##
##############################################
```bash
## ‚öôÔ∏è Install dependencies ##
sudo yum install epel-release -y
sudo yum install gcc-c++ make pam-devel libcurl-devel openssl-devel -y

## ‚öôÔ∏è Build privacyidea-pam ##
cd /home/<your-user>
git clone https://github.com/privacyidea/privacyidea-pam.git
cd privacyidea-pam
wget https://github.com/nlohmann/json/releases/download/v3.11.3/json.hpp -O include/json.hpp
make
sudo make install

## ‚öôÔ∏è Configure SSH ##
Edit /etc/ssh/sshd_config:

PasswordAuthentication no
ChallengeResponseAuthentication yes
AuthenticationMethods publickey,keyboard-interactive
UsePAM yes
# Optional: disable OTP for specific users
Match User <username>
    AuthenticationMethods publickey

## ‚öôÔ∏è Configure PAM ##
Edit /etc/pam.d/sshd:
 * Comment out the default line:
#@include common-auth
 * Add this at the top:
auth required pam_privacyidea.so url=https://<PRIVACYIDEA_SERVER> nossl debug
account required pam_unix.so
session include system-auth

## ‚öôÔ∏è Restart SSHD ##
sudo systemctl restart sshd

##############################################
## ‚öôÔ∏è Ubuntu Installation (Using Package)  ##
##############################################

## ‚öôÔ∏è Install dependencies ##
sudo apt-get update
sudo apt-get install privacyidea-pam -y

## ‚öôÔ∏è Configure PAM ##
Edit /etc/pam.d/sshd:
* Comment out the default line:
#@include common-auth
* Add this at the top:
auth required pam_python.so /lib/security/privacyidea_pam.py url=https://<PRIVACYIDEA_SERVER> auth nosslverify debug
account required pam_unix.so

## ‚öôÔ∏è Configure SSH ##
Edit /etc/ssh/sshd_config:
PasswordAuthentication no
ChallengeResponseAuthentication yes
AuthenticationMethods publickey,keyboard-interactive
UsePAM yes
# Optional: disable OTP for specific users
Match User <username>
    AuthenticationMethods publickey

## ‚öôÔ∏è Restart SSHD ##
sudo systemctl restart sshd

################
##üîë Testing ##
################

* Ensure your user has a registered OTP token in PrivacyIDEA.
*Try logging in with SSH:
ssh <user>@<server>
* You will be asked for:
Public key authentication
OTP verification from PrivacyIDEA

References

PrivacyIDEA PAM GitHub: https://github.com/privacyidea/privacyidea-pam

PrivacyIDEA Documentation: https://privacyidea.readthedocs.io/en/latest/
